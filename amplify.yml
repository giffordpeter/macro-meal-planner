version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # Install dependencies
            - npm ci
            # Load environment variables from Parameter Store
            - |
              BRANCH=$(echo $AWS_BRANCH)
              if [ "$BRANCH" = "main" ]; then
                ENV="production"
              else
                ENV="staging"
              fi
              echo "Loading parameters for $ENV environment..."
              
              # Function to load parameters
              load_parameter() {
                local name=$1
                local param_path="/macro-meal-planner/$ENV/$name"
                local value=$(aws ssm get-parameter --name "$param_path" --with-decryption --query "Parameter.Value" --output text)
                echo "export $name=\"$value\"" >> .env
              }
              
              # Load all required parameters
              load_parameter "NEXTAUTH_URL"
              load_parameter "DATABASE_URL"
              load_parameter "AUTH_GITHUB_ID"
              load_parameter "AUTH_GITHUB_SECRET"
              load_parameter "NEXTAUTH_SECRET"
              load_parameter "OPENAI_API_KEY"
              load_parameter "NODE_ENV"
              load_parameter "PORT"
              
              echo "Environment variables loaded successfully"
        build:
          commands:
            # Run build validation
            - node scripts/validate-build.js
            # Build the application
            - npm run build
        postBuild:
          commands:
            - echo "Build completed successfully"
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
      appRoot: .
