version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # Setup Node.js
            - nvm use 18
            - node -v
            
            # Install dependencies
            - npm ci
            - npm run prisma:generate
            
            # Load environment variables from AWS Parameter Store
            - |
              # Load environment variables from Parameter Store
              load_ssm_params() {
                local env=$1
                local prefix="/macro-meal-planner/${env}"
                
                params=$(aws ssm get-parameters-by-path \
                  --path "${prefix}" \
                  --with-decryption \
                  --recursive \
                  --query "Parameters[*].[Name,Value]" \
                  --output text)
                
                echo "${params}" | while read -r name value; do
                  # Extract parameter name without path prefix
                  param_name=$(basename "${name}")
                  echo "${param_name}=${value}" >> .env.production
                done
              }
              
              # Load environment-specific variables
              if [ "${BUILD_ENV}" = "staging" ]; then
                load_ssm_params "staging"
              else
                load_ssm_params "production"
              fi
            
        build:
          commands:
            - echo "Building Next.js application..."
            - npm run build
            
        postBuild:
          commands:
            - echo "Running post-build validation..."
            - node scripts/validate-build.js
            
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
          - .prisma/**/*
    appRoot: .
